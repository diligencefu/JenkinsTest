name: iOS Build and Upload

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Xcode
      uses: actions/setup-xcode@v2
      with:
        xcode-version: '14.3.1'

    - name: Install dependencies
      run: |
        cd /Users/fuyaohui/Desktop/JenkinsTest
        pod install

    - name: Build and Archive
      run: |
        cd /Users/fuyaohui/Desktop/JenkinsTest
        xcodebuild clean archive -scheme JenkinsTest -archivePath "build/JenkinsTest.xcarchive"

    - name: Export IPA
      run: |
        cd /Users/fuyaohui/Desktop/JenkinsTest
        xcodebuild -exportArchive -archivePath "build/JenkinsTest.xcarchive" -exportOptionsPlist "exportOptions.plist" -exportPath "build"

    - name: Upload to App Store
      run: |
        cd /Users/fuyaohui/Desktop/JenkinsTest
        xcrun altool --upload-app -f "build/JenkinsTest.ipa" -u "diligencefu@sina.com" -p "kwby-cfyy-bchh-pawx"
